'use strict'
class Query {
    constructor(conn, sql, params){
        this.promise = query(conn, sql, params)
    }
    first(){
        return this.promise.then(rows => {
            if(rows.length) return rows[0]
            else throw new Error("NOT FOUND")
        })
    }
    toObject(key){
        return this.promise.then(rows => rows.reduce((r,v)=>{
            r[v[key]] = v
            return r
        }, {}))
    }
    then(f) {
        return this.promise.then(f)
    }
    static create(...args){
        return new Query(...args)
    }
}

const query = (conn, sql, params) => new Promise((resolve, reject) => {
    conn.query(sql, params, (err, rows) => {
        if(err) reject(err)
        else resolve(rows)
    })
})

module.exports = Query;
